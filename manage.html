<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Manage Reservations</title>
  <link rel="stylesheet" href="terminal-theme.css" />
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    nav { text-align: center; margin: 16px 0; }
    nav a { margin: 0 8px; text-decoration: none; }
    h2 { margin-bottom: 10px; }
    .form-group { margin-bottom: 15px; }
    label { display: block; margin-bottom: 6px; }
    input[type="text"], input[type="file"] {
      width: 300px; padding: 8px; box-sizing: border-box;
      margin-right: 10px;
    }
    button {
      padding: 8px 16px; cursor: pointer;
      border: none; border-radius: 4px; font-size: 14px;
      margin-right: 5px;
    }
    #btnSearch { background-color: #007bff; color: white; }
    #results { margin-top: 20px; }
    table {
      border-collapse: collapse; width: 100%;
    }
    th, td {
      border: 1px solid #999; padding: 8px; text-align: left;
    }
    th { background-color: #f0f0f0; }
    .action-btn {
      padding: 4px 8px; font-size: 12px;
      border: none; border-radius: 4px; cursor: pointer;
      margin-right: 4px;
    }
    .cancel-btn      { background-color: #dc3545; color: white; }
    .add-seat-btn    { background-color: #28a745; color: white; }
    .remove-seat-btn { background-color: #ffc107; color: black; }
    .swap-seat-btn   { background-color: #17a2b8; color: white; }
    .no-results { margin-top: 20px; font-style: italic; }

    /* Swap‚Äêmodal styles */
    #swapModal {
      display: none;
      position: fixed;
      top: 5%; left: 5%;
      width: 90%; height: 90%;
      background: white;
      border: 2px solid #333;
      overflow: auto;
      padding: 16px;
      z-index: 1000;
    }
    #swapModal h3 { margin-top: 0; }
    #swapChart { border-collapse: collapse; margin: 20px auto; }
    #swapChart th, #swapChart td {
      border: 1px solid #999; padding: 4px; text-align: center;
    }
    .seat-btn {
      width: 40px; height: 40px;
      background-color: #007bff; color: white;
      border: none; border-radius: 4px; font-size: 12px;
      cursor: pointer;
    }
    .seat-btn.disabled { background-color: #6c757d; cursor: not-allowed; }
    .seat-btn.selected { background-color: #28a745 !important; }
  </style>
</head>
<body class="terminal">
  <div class="terminal-container">
  <nav>
    <a href="purchase.html">üéüÔ∏è Purchase Ticket</a> |
    <a href="manage.html">üõ†Ô∏è Manage Reservation</a> |
    <a href="navigate.html">üìç Theater Navigate</a>
  </nav>

  <h2>Manage Reservations</h2>

  <div class="form-group">
    <label for="qrInput">Scan Ticket QR Code:</label>
    <input type="file" id="qrInput" accept="image/*" />
  </div>

  <div class="form-group">
    <label for="searchInput">Or enter Email or Ticket ID:</label>
    <input type="text" id="searchInput"
           placeholder="e.g. john@example.com or A1B2C3D4" />
    <button id="btnSearch">Search</button>
  </div>

  <div id="results"></div>

  <!-- Swap‚ÄêSeat Modal -->
  <div id="swapModal">
    <h3>Choose a new seat</h3>
    <button id="swapCancel">Cancel</button>
    <table id="swapChart">
      <!-- generated by JS -->
    </table>
  </div>

  <script>
    const PRICE = 6.00;

    function loadReservations() {
      const s = localStorage.getItem("reservations");
      try { return s ? JSON.parse(s) : []; }
      catch { return []; }
    }
    function saveReservations(arr) {
      localStorage.setItem("reservations", JSON.stringify(arr));
    }
    function shouldDisplay(term) {
      const t = term.toLowerCase().trim();
      return r => r.email.toLowerCase() === t || r.id.toLowerCase() === t;
    }
    function groupByReservation(arr) {
      return arr.reduce((groups,r)=> {
        const key = r.groupID || r.id;
        (groups[key] = groups[key]||[]).push(r);
        return groups;
      }, {});
    }

    let currentGroupID, currentMovie, currentTime, swapOldSeat;

    function renderResults(filtered) {
      const container = document.getElementById("results");
      container.innerHTML = "";
      if (!filtered.length) {
        container.innerHTML = '<div class="no-results">No matching reservations found.</div>';
        return;
      }
      const groups = groupByReservation(filtered);
      const table = document.createElement("table");
      const thead = document.createElement("thead");
      const headerRow = document.createElement("tr");
      ["Ticket ID(s)","Name","Email","Movie","Showtime","Seat(s)","Booked At","Actions"]
        .forEach(txt => {
          const th = document.createElement("th"); th.textContent = txt;
          headerRow.appendChild(th);
        });
      thead.appendChild(headerRow);
      table.appendChild(thead);
      const tbody = document.createElement("tbody");

      Object.entries(groups).forEach(([groupID,list])=>{
        const tr = document.createElement("tr");
        const name      = list[0].name;
        const email     = list[0].email;
        const movie     = list[0].movie;
        const time      = list[0].time;
        const seats     = list.map(r=>r.seat).join(", ");
        const ticketIDs = list.map(r=>r.id).join(", ");
        const bookedAt  = new Date(Math.min(...list.map(r=>new Date(r.timestamp))))
                           .toLocaleString();
        [ticketIDs,name,email,movie,time,seats,bookedAt].forEach(txt=>{
          const td = document.createElement("td"); td.textContent = txt;
          tr.appendChild(td);
        });

        const tdAct = document.createElement("td");

        // Swap Seat
        const swapBtn = document.createElement("button");
        swapBtn.textContent = "Swap Seat";
        swapBtn.className   = "action-btn swap-seat-btn";
        swapBtn.addEventListener("click", ()=>{
          currentGroupID = groupID;
          currentMovie   = list[0].movie;
          currentTime    = list[0].time;
          // pick old seat once
          if (list.length === 1) {
            swapOldSeat = list[0].seat;
          } else {
            const choice = prompt(
              `Which seat do you want to swap?\nCurrently: ${seats}`
            );
            if (!choice) return;
            swapOldSeat = choice.trim().toUpperCase();
            if (!list.some(r=>r.seat===swapOldSeat)) {
              return alert("‚ùå That seat is not in this reservation.");
            }
          }
          openSwapModal();
        });
        tdAct.appendChild(swapBtn);

        // Cancel All
        const cancelBtn = document.createElement("button");
        cancelBtn.textContent = "Cancel All";
        cancelBtn.className   = "action-btn cancel-btn";
        cancelBtn.addEventListener("click", ()=>{
          if (!confirm("Cancel **all** seats in this reservation?")) return;
          alert(`‚úÖ Canceled and refunded $${(list.length*PRICE).toFixed(2)}.`);
          const updated = loadReservations()
            .filter(r=> (r.groupID||r.id)!==groupID);
          saveReservations(updated);
          renderResults(updated.filter(shouldDisplay(
            document.getElementById("searchInput").value
          )));
        });
        tdAct.appendChild(cancelBtn);

        // Add Seat
        const addBtn = document.createElement("button");
        addBtn.textContent = "Add Seat";
        addBtn.className   = "action-btn add-seat-btn";
        addBtn.addEventListener("click", ()=>{
          localStorage.setItem("prefill", JSON.stringify({
            groupID, name, email, movie, time
          }));
          localStorage.setItem("fromManage","true");
          window.location.href="purchase.html";
        });
        tdAct.appendChild(addBtn);

        // Remove Seat
        const removeBtn = document.createElement("button");
        removeBtn.textContent = "Remove Seat";
        removeBtn.className   = "action-btn remove-seat-btn";
        removeBtn.addEventListener("click", ()=>{
          const seat = prompt(`Which seat to remove?\nCurrently: ${seats}`);
          if (!seat) return;
          const up = seat.trim().toUpperCase();
          if (!list.some(r=>r.seat===up)) return alert("‚ùå Not in this reservation.");
          if (!confirm(`Refund $${PRICE.toFixed(2)} for seat ${up}?`)) return;
          const updated = loadReservations().filter(r=>
            !((r.groupID||r.id)===groupID && r.seat===up)
          );
          saveReservations(updated);
          alert(`‚úÖ Removed seat ${up}.`);
          renderResults(
            updated.filter(shouldDisplay(
              document.getElementById("searchInput").value
            ))
          );
        });
        tdAct.appendChild(removeBtn);

        tr.appendChild(tdAct);
        tbody.appendChild(tr);
      });

      table.appendChild(tbody);
      container.appendChild(table);
    }

    document.getElementById("btnSearch")
      .addEventListener("click", ()=>{
        const term = document.getElementById("searchInput").value.trim();
        if (!term) return alert("Please enter an email or Ticket ID.");
        const filtered = loadReservations().filter(shouldDisplay(term));
        renderResults(filtered);
      });

    // ‚Äî Swap Modal Logic ‚Äî
    const swapModal  = document.getElementById("swapModal");
    const swapChart  = document.getElementById("swapChart");
    const swapCancel = document.getElementById("swapCancel");
    swapCancel.addEventListener("click", ()=> swapModal.style.display="none");

    function openSwapModal() {
      const rows = ["A","B","C"];
      swapChart.innerHTML = "";
      // header
      let thead = "<tr><th></th>";
      for (let c=1; c<=10; c++) thead += `<th>${c}</th>`;
      thead += "</tr>";
      swapChart.insertAdjacentHTML("beforeend", thead);
      // body
      rows.forEach(r=>{
        let row = `<tr><td><strong>${r}</strong></td>`;
        for (let c=1; c<=10; c++){
          const seat = r + c;
          const taken = loadReservations().some(rr=>
            rr.movie===currentMovie &&
            rr.time===currentTime &&
            rr.seat===seat
          );
          row += `<td>
            <button class="seat-btn${taken?" disabled":""}"
                    data-seat="${seat}">
              ${seat}
            </button>
          </td>`;
        }
        row += "</tr>";
        swapChart.insertAdjacentHTML("beforeend", row);
      });
      // click once per button
      Array.from(swapChart.querySelectorAll(".seat-btn"))
        .forEach(btn=>{
          if (btn.classList.contains("disabled")) return;
          btn.addEventListener("click", ()=>{
            const newSeat = btn.dataset.seat;
            const all = loadReservations();
            all.forEach(r=>{
              if ((r.groupID||r.id)===currentGroupID && r.seat===swapOldSeat) {
                r.seat = newSeat;
              }
            });
            saveReservations(all);
            alert(`‚úÖ Swapped ${swapOldSeat} ‚Üí ${newSeat}`);
            swapModal.style.display="none";
            renderResults(all.filter(shouldDisplay(
              document.getElementById("searchInput").value
            )));
          }, { once: true });
        });
      swapModal.style.display = "block";
    }
  </script>
</body>
</html>
