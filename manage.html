<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Manage Reservations</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    nav { text-align:center; margin:16px 0; }
    nav a { margin: 0 8px; text-decoration: none; }
    h2 { margin-bottom: 10px; }
    .form-group { margin-bottom: 15px; }
    label { display: block; margin-bottom: 6px; }
    input[type="text"] {
      width: 300px; padding: 8px; box-sizing: border-box;
      margin-right: 10px;
    }
    button {
      padding: 8px 16px; cursor: pointer;
      border: none; border-radius: 4px; font-size: 14px;
      margin-right: 5px;
    }
    #btnSearch { background-color: #007bff; color: white; }
    #results { margin-top: 20px; }
    table {
      border-collapse: collapse; width: 100%;
    }
    th, td {
      border: 1px solid #999; padding: 8px; text-align: left;
    }
    th { background-color: #f0f0f0; }
    .action-btn {
      padding: 4px 8px; font-size: 12px;
      border: none; border-radius: 4px; cursor: pointer;
      margin-right: 4px;
    }
    .cancel-btn { background-color: #dc3545; color: white; }
    .add-seat-btn { background-color: #28a745; color: white; }
    .no-results { margin-top: 20px; font-style: italic; }
  </style>
</head>
<body>
  <nav>
    <a href="index.html">üéüÔ∏è Purchase Ticket</a> |
    <a href="manage.html">üõ†Ô∏è Manage Reservation</a> |
    <a href="navigate.html">üìç Theater Navigate</a>
  </nav>

  <h2>Manage Reservations</h2>
  <div class="form-group">
    <label for="searchInput">Enter Email or Ticket ID:</label>
    <input type="text" id="searchInput"
           placeholder="e.g. john@example.com or A1B2C3D4" />
    <button id="btnSearch">Search</button>
  </div>

  <div id="results"></div>

  <script>
    function loadReservations() {
      const s = localStorage.getItem("reservations");
      if (!s) return [];
      try { return JSON.parse(s); }
      catch { return []; }
    }
    function saveReservations(arr) {
      localStorage.setItem("reservations", JSON.stringify(arr));
    }

    function shouldDisplay(term) {
      const t = term.toLowerCase().trim();
      return r => r.email.toLowerCase() === t || r.id.toLowerCase() === t;
    }

    function renderResults(arr) {
      const container = document.getElementById("results");
      container.innerHTML = "";
      if (!arr || arr.length === 0) {
        container.innerHTML =
          '<div class="no-results">No matching reservations found.</div>';
        return;
      }
      const table = document.createElement("table");
      const thead = document.createElement("thead");
      const headerRow = document.createElement("tr");
      ["Ticket ID","Name","Email","Movie","Showtime","Seat","Booked At","Actions"]
        .forEach(text => {
          const th = document.createElement("th"); th.textContent = text;
          headerRow.appendChild(th);
        });
      thead.appendChild(headerRow);
      table.appendChild(thead);

      const tbody = document.createElement("tbody");
      arr.forEach(res => {
        const tr = document.createElement("tr");
        ["id","name","email","movie","time","seat"].forEach(key => {
          const td = document.createElement("td");
          td.textContent = res[key];
          tr.appendChild(td);
        });
        // timestamp
        const tdTime = document.createElement("td");
        tdTime.textContent = new Date(res.timestamp).toLocaleString();
        tr.appendChild(tdTime);

        // actions
        const tdAct = document.createElement("td");
        // cancel
        const cancelBtn = document.createElement("button");
        cancelBtn.textContent = "Cancel";
        cancelBtn.className = "action-btn cancel-btn";
        cancelBtn.addEventListener("click", () => {
          if (!confirm(`Cancel ticket ${res.id} for seat ${res.seat}?`)) return;
          alert("‚úÖ Your ticket has been canceled.\nüí∏ A refund will be issued.");
          const all = loadReservations();
          const updated = all.filter(r => r.id !== res.id);
          saveReservations(updated);
          renderResults(updated.filter(shouldDisplay(
            document.getElementById("searchInput").value
          )));
        });
        tdAct.appendChild(cancelBtn);

        // add seat
        const addBtn = document.createElement("button");
        addBtn.textContent = "Add Seat";
        addBtn.className = "action-btn add-seat-btn";
        addBtn.addEventListener("click", () => {
          localStorage.setItem("prefill", JSON.stringify({
            name: res.name, email: res.email,
            movie: res.movie, time: res.time
          }));
          localStorage.setItem("fromManage","true");
          window.location.href = "index.html";
        });
        tdAct.appendChild(addBtn);

        tr.appendChild(tdAct);
        tbody.appendChild(tr);
      });
      table.appendChild(tbody);
      container.appendChild(table);
    }

    document.getElementById("btnSearch")
      .addEventListener("click", () => {
        const term = document.getElementById("searchInput").value.trim();
        if (!term) {
          alert("Please enter an email or Ticket ID.");
          return;
        }
        renderResults(loadReservations().filter(shouldDisplay(term)));
      });
  </script>
</body>
</html>
